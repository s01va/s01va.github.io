{"componentChunkName":"component---node-modules-gatsby-theme-portfolio-minimal-src-templates-article-index-tsx","path":"/gitlab-cicd-setting/","result":{"pageContext":{"article":{"banner":{"alt":null,"caption":null,"src":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/e5e859a8d6e0acdf15ad3dad4f1c979a/bc51f/0.png","srcSet":"/static/e5e859a8d6e0acdf15ad3dad4f1c979a/41200/0.png 165w,\n/static/e5e859a8d6e0acdf15ad3dad4f1c979a/f979a/0.png 330w,\n/static/e5e859a8d6e0acdf15ad3dad4f1c979a/bc51f/0.png 660w","sizes":"(min-width: 660px) 660px, 100vw"},"sources":[{"srcSet":"/static/e5e859a8d6e0acdf15ad3dad4f1c979a/322ad/0.webp 165w,\n/static/e5e859a8d6e0acdf15ad3dad4f1c979a/de3b3/0.webp 330w,\n/static/e5e859a8d6e0acdf15ad3dad4f1c979a/2b2b5/0.webp 660w","type":"image/webp","sizes":"(min-width: 660px) 660px, 100vw"}]},"width":660,"height":400}}}},"body":"<h3>대단히 하고 있던 착각</h3>\n<ul>\n<li>\n<p>모든 동작은 호스트에서 이루어진다 X</p>\n</li>\n<li>\n<p>모든 동작은 <strong>Runner container 내부에서</strong> 이루어진다.</p>\n<p>그래서 모든 동작은 일회성으로 끝남.</p>\n<p>gradlew build 후 굳이 artifact로 넘겨주거나, \"배포\"한다고 해놓고 dockerhub에 push해놓고 끝나는 이유가 여기에 있었음</p>\n<p><strong>모든 동작은 runner container 내부에서 동작</strong> 후 해당 runner container는 죽기 때문에, 저장하고 어쩌고 해봤자 다 사라짐</p>\n</li>\n<li>\n<p>.gitlab-ci.yml file</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">stages</span><span class=\"token punctuation\">:</span>          <span class=\"token comment\"># List of stages for jobs, and their order of execution</span>\r\n  <span class=\"token punctuation\">-</span> build\r\n  <span class=\"token punctuation\">-</span> deploy\r\n\r\n<span class=\"token key atrule\">variables</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">IMAGE_NAME</span><span class=\"token punctuation\">:</span> test_image_name\r\n  <span class=\"token comment\"># DOCKER_HOST: tcp://dindhost:2375</span>\r\n  <span class=\"token comment\"># DOCKER_DRIVER: overlay2</span>\r\n  <span class=\"token key atrule\">DOCKER_TLS_CERTDIR</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\r\n\r\n<span class=\"token key atrule\">build-job</span><span class=\"token punctuation\">:</span>       <span class=\"token comment\"># This job runs in the build stage, which runs first.</span>\r\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> build\r\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> openjdk<span class=\"token punctuation\">:</span><span class=\"token number\">8</span>\r\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> ./gradlew clean build\r\n  <span class=\"token key atrule\">artifacts</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> build/libs/ihms<span class=\"token punctuation\">-</span>0.0.1<span class=\"token punctuation\">-</span>SNAPSHOT.jar\r\n    <span class=\"token key atrule\">expire_in</span><span class=\"token punctuation\">:</span> 10min\r\n\r\n<span class=\"token key atrule\">deploy-job</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> deploy\r\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">:</span>latest\r\n  <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">:</span>dind\r\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> docker build <span class=\"token punctuation\">-</span>t $IMAGE_NAME .\r\n    <span class=\"token punctuation\">-</span> docker stop $IMAGE_NAME\r\n    <span class=\"token punctuation\">-</span> docker rm $IMAGE_NAME\r\n    <span class=\"token punctuation\">-</span> docker run <span class=\"token punctuation\">-</span>d <span class=\"token punctuation\">-</span>p 8081<span class=\"token punctuation\">:</span>8081 <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>name $IMAGE_NAME <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>restart always $IMAGE_NAME<span class=\"token punctuation\">:</span>latest\r\n</code></pre></div>\n</li>\n<li>\n<p>/srv/gitlab-runner/config/config.toml</p>\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token key property\">concurrent</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">1</span>\r\n<span class=\"token key property\">check_interval</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span>\r\n\r\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">session_server</span><span class=\"token punctuation\">]</span>\r\n  <span class=\"token key property\">session_timeout</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">1800</span>\r\n\r\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">runners</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\r\n  <span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"runnername\"</span>\r\n  <span class=\"token key property\">url</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"http://url:port/\"</span>\r\n  <span class=\"token key property\">token</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"token\"</span>\r\n  <span class=\"token key property\">executor</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"docker\"</span>\r\n  <span class=\"token punctuation\">[</span><span class=\"token table class-name\">runners.custom_build_dir</span><span class=\"token punctuation\">]</span>\r\n  <span class=\"token punctuation\">[</span><span class=\"token table class-name\">runners.cache</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">[</span><span class=\"token table class-name\">runners.cache.s3</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">[</span><span class=\"token table class-name\">runners.cache.gcs</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">[</span><span class=\"token table class-name\">runners.cache.azure</span><span class=\"token punctuation\">]</span>\r\n  <span class=\"token punctuation\">[</span><span class=\"token table class-name\">runners.docker</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token key property\">tls_verify</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span>\r\n    <span class=\"token key property\">image</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"docker:stable\"</span>\r\n    <span class=\"token key property\">privileged</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\r\n    <span class=\"token key property\">disable_entrypoint_overwrite</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span>\r\n    <span class=\"token key property\">oom_kill_disable</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span>\r\n    <span class=\"token key property\">disable_cache</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span>\r\n    <span class=\"token key property\">volumes</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/var/run/docker.sock:/var/run/docker.sock\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/cache\"</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token key property\">shm_size</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span></code></pre></div>\n</li>\n</ul>","categories":["setting"],"date":"November 16, 2022","description":null,"id":"7e7801d5-0705-53f7-acb2-ea2e8a82c619","keywords":["gitlab","docker"],"slug":"/gitlab-cicd-setting/","title":"GitLab CI/CD 사용기","readingTime":{"text":"2 min read"}},"listingPagePath":"/blog/"}},"staticQueryHashes":["1094019748","460736852"],"slicesMap":{}}